<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>HFP AI | HealthFirstPriority</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@300;400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        @media (max-width: 640px) { ::-webkit-scrollbar { display: none; } }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AI Text Styling */
        .ai-text { 
            font-family: 'Merriweather', serif; 
            font-size: 1rem; 
            line-height: 1.7; 
            color: #334155;
            white-space: pre-wrap; 
        }
        @media (max-width: 640px) { .ai-text { font-size: 0.95rem; } }

        /* Thinking Animation */
        .thinking { display: inline-flex; gap: 4px; padding: 8px 0; }
        .dot { width: 4px; height: 4px; background: #94a3b8; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Input Placeholder */
        textarea::placeholder { color: #94a3b8; font-size: 13px; font-weight: 500; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-slate-50 relative text-sm md:text-base">

    <header class="absolute top-4 left-4 z-30 flex items-center gap-2.5">
        <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-600/20">
            <i class="fa-solid fa-heart-pulse text-white text-sm"></i>
        </div>
        <div class="flex flex-col">
            <span class="font-bold text-slate-800 leading-tight tracking-tight">HFP<span class="text-blue-600">.ai</span></span>
            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-widest leading-none">Internal</span>
        </div>
    </header>

    <header class="absolute top-4 right-4 z-30">
        <div class="flex items-center gap-2 bg-white/80 backdrop-blur border border-slate-200 pl-2 pr-3 py-1 rounded-full shadow-sm">
            <div id="dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
            <span id="stat" class="text-[9px] md:text-[10px] uppercase font-bold text-slate-400 tracking-wider">OFFLINE</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col max-w-3xl mx-auto w-full relative min-h-0">
        <div id="chat" class="flex-1 overflow-y-auto px-4 md:px-6 py-6 space-y-6 md:space-y-8 scroll-smooth pb-4">
            <div id="welcome" class="flex flex-col items-center justify-center h-full text-slate-400 select-none">
                <div class="w-16 h-16 bg-blue-50 rounded-2xl flex items-center justify-center mb-4 border border-blue-100">
                    <i class="fa-solid fa-staff-snake text-3xl text-blue-600 opacity-90"></i>
                </div>
                <h1 class="text-xl font-bold text-slate-800 mb-1">HealthFirstPriority</h1>
                <p class="text-xs font-semibold text-slate-400 uppercase tracking-widest mb-6">Research Assistant</p>
                <p class="text-sm text-slate-500 max-w-xs text-center">Secure environment for distributed LLM testing and medical data analysis.</p>
            </div>
        </div>
        
        <div class="px-2 md:px-4 pb-3 md:pb-4 pt-2 w-full z-20 bg-slate-50/90 backdrop-blur-sm">
            <div class="max-w-3xl mx-auto relative flex flex-col gap-2">
                
                <div class="bg-white rounded-[24px] px-3 md:px-4 py-3 relative shadow-sm transition-all focus-within:ring-2 focus-within:ring-blue-100 border border-slate-200">
                    
                    <textarea id="in" rows="1" class="w-full bg-transparent border-none outline-none text-sm font-medium text-slate-800 resize-none max-h-32 focus:ring-0 p-0" placeholder="Ask HFP Intelligence..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();app.send();}"></textarea>
                    
                    <div class="flex items-center justify-between mt-2 gap-2 flex-wrap sm:flex-nowrap">
                        
                        <button onclick="app.clear()" class="flex-none flex items-center gap-1.5 px-3 py-1.5 rounded-full bg-slate-50 hover:bg-slate-100 text-slate-600 transition-colors border border-slate-200 text-[10px] font-bold group">
                            <i class="fa-solid fa-rotate-right text-[10px] group-hover:rotate-180 transition-transform"></i> <span class="hidden xs:inline">Reset Context</span><span class="xs:hidden">Reset</span>
                        </button>

                        <div class="flex items-center gap-2 relative ml-auto sm:ml-0 max-w-full">
                            
                            <div class="relative flex-shrink min-w-0">
                                <button onclick="ui.toggleDrop()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-50 hover:bg-slate-100 border border-slate-200 rounded-lg transition-all cursor-pointer group w-full max-w-[140px] md:max-w-none">
                                    <i class="fa-solid fa-microchip text-blue-500 text-[10px] flex-none"></i>
                                    <span id="h-model" class="text-[10px] font-bold text-slate-700 truncate block">Initializing...</span>
                                    <i class="fa-solid fa-chevron-up text-[9px] text-slate-400 flex-none ml-auto"></i>
                                </button>

                                <div id="drop" class="absolute bottom-full right-0 mb-1 w-64 max-w-[90vw] bg-white border border-slate-200 rounded-xl shadow-xl hidden z-50 flex flex-col overflow-hidden ring-1 ring-black/5">
                                    <div class="p-2 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                                        <span class="text-[10px] font-bold text-slate-500 uppercase">Active Models</span>
                                        <span id="cnt" class="text-[9px] bg-blue-100 text-blue-700 font-bold px-1.5 rounded-full">0</span>
                                    </div>
                                    <div id="list" class="max-h-48 overflow-y-auto p-1 custom-scroll"></div>
                                </div>
                            </div>

                            <button id="btn" onclick="app.send()" class="w-8 h-8 rounded-full bg-blue-600 text-white hover:bg-blue-700 hover:shadow-lg hover:shadow-blue-600/30 transition-all flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex-none disabled:shadow-none">
                                <i class="fa-solid fa-paper-plane text-xs translate-x-[-1px] translate-y-[1px]"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-[9px] md:text-[10px] font-medium text-slate-400 px-2">
                    HFP Internal Tool. Verify all medical & data outputs.
                </div>
            </div>
        </div>
    </main>

<script>
const $ = id => document.getElementById(id);
const API = 'https://ai.nomineelife.com/backup'; 
const state = { model: "Unknown", list: [], connected: false, history: [], busy: false };

const ui = {
    toggleDrop: () => $('drop').classList.toggle('hidden'),
    
    setStatus: (online, msg) => {
        $('dot').className = `w-2 h-2 rounded-full ${online ? 'bg-emerald-500' : 'bg-red-500'}`;
        $('stat').innerText = online ? "SYSTEM ONLINE" : "SYSTEM OFFLINE";
        $('stat').className = `text-[9px] md:text-[10px] uppercase font-extrabold tracking-wider ${online ? 'text-emerald-700' : 'text-slate-400'}`;
        if(msg) $('h-model').innerText = msg;
    },
    
    setModel: (id) => {
        state.model = id;
        $('h-model').innerText = id;
        $('drop').classList.add('hidden');
        ui.renderList();
    },
    
    renderList: () => {
        $('list').innerHTML = '';
        $('cnt').innerText = state.list.length;
        if(!state.list.length) $('list').innerHTML = '<div class="p-3 text-center text-[10px] text-slate-500 font-medium">No models found</div>';
        
        state.list.forEach(m => {
            const btn = document.createElement('button');
            const active = m.id === state.model;
            btn.className = `w-full text-left px-2 py-2 text-[10px] flex items-center gap-2 rounded-md transition-all border border-transparent ${active ? 'bg-blue-50 text-blue-700 font-bold border-blue-100' : 'text-slate-600 hover:bg-slate-50 hover:text-slate-900 font-medium'}`;
            btn.innerHTML = `
                <div class="w-1.5 h-1.5 rounded-full flex-none ${active ? 'bg-blue-600' : 'bg-slate-300'}"></div>
                <div class="flex-1 break-all">${m.id}</div>
            `;
            btn.onclick = () => ui.setModel(m.id);
            $('list').appendChild(btn);
        });
    },

    addMsg: (role, text, thinking=false) => {
        const div = document.createElement('div');
        div.className = `flex w-full fade-in ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        
        if (role === 'user') {
            // Updated User Bubble: HFP Blue with White text
            div.innerHTML = `
                <div class="bg-blue-600 text-white font-medium px-4 py-2.5 rounded-[20px] rounded-tr-sm text-[14px] max-w-[90%] md:max-w-[85%] shadow-md shadow-blue-900/10 border border-blue-500 break-words leading-relaxed">
                    ${text}
                </div>
            `;
        } else {
            // Updated AI Bubble: Clean
            div.innerHTML = `
                <div class="w-full max-w-full group">
                    ${thinking ? `
                        <div id="thk" class="thinking pl-1">
                            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                        </div>` : ''}
                    
                    <div class="${thinking ? 'hidden' : ''}" id="content-box">
                        <div class="ai-text pl-1 text-[15px] text-slate-700"></div>
                    </div>
                    
                    <div class="flex flex-wrap gap-1.5 mt-2 opacity-0 transition-opacity duration-500 pl-1" id="metrics"></div>
                </div>`;
        }
        
        $('chat').appendChild(div);
        $('chat').scrollTop = $('chat').scrollHeight;
        
        return role === 'ai' ? { 
            box: div.querySelector('#content-box'), 
            txt: div.querySelector('.ai-text'), 
            met: div.querySelector('#metrics'),
            thk: div.querySelector('#thk') 
        } : null;
    }
};

const app = {
    init: async (refresh=false) => {
        if(refresh) $('list').innerHTML = '<div class="p-4 text-center text-xs text-slate-500">Connecting to Neural Core...</div>';
        try {
            const res = await fetch(`${API}/models?t=${Date.now()}`);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            state.list = data.data || [];
            state.list = state.list.map(m => ({ ...m, id: m.id.split('/').pop().replace('.gguf','') }));

            if(!state.list.find(m=>m.id===state.model)) state.model = state.list[0]?.id || "No Models";
            state.connected = true;
            ui.setStatus(true);
            ui.setModel(state.model);
        } catch (e) {
            console.error(e);
            state.connected = false;
            ui.setStatus(false, "Offline");
            state.list = [];
            ui.renderList();
        }
    },
    
    send: async () => {
        const text = $('in').value.trim();
        if(!text || state.busy) return;
        
        if(!state.connected && state.list.length === 0) { 
           await app.init();
           if(!state.connected) { alert('Cannot connect to HFP Server.'); return; }
        }
        
        state.busy = true;
        $('welcome').style.display = 'none';
        $('in').value = ''; $('in').disabled = true; $('btn').disabled = true; $('btn').classList.add('opacity-50');
        
        state.history.push({ role: 'user', content: text });
        ui.addMsg('user', text);
        const dom = ui.addMsg('ai', '', true);

        let full = "", t0 = performance.now(), tFirst = 0, count = 0, svrToks = 0, svrSpeed = 0, serverModel = "";
        
        try {
            const res = await fetch(`${API}/chat/completions`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ model: state.model, messages: state.history, stream: true })
            });
            
            if(!res.ok) throw new Error("API Error: " + res.status);

            const reader = res.body.getReader();
            const dec = new TextDecoder();

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = dec.decode(value);
                const lines = chunk.split('\n');
                
                for(const line of lines) {
                    if(line.startsWith('data: ') && !line.includes('[DONE]')) {
                        try {
                            const json = JSON.parse(line.slice(6));
                            if(json.model && !serverModel) {
                                serverModel = json.model.split('/').pop().replace('.gguf','');
                            }
                            if(json.timings?.predicted_n) svrSpeed = json.timings.predicted_n / (json.timings.predicted_ms/1000);
                            if(json.usage?.completion_tokens) svrToks = json.usage.completion_tokens;
                            const delta = json.choices[0]?.delta?.content;
                            if(delta) {
                                if(!tFirst) { tFirst = performance.now(); dom.thk.remove(); dom.box.classList.remove('hidden'); }
                                full += delta; dom.txt.textContent = full; count++;
                                $('chat').scrollTop = $('chat').scrollHeight;
                            }
                        } catch {}
                    }
                }
            }
            state.history.push({ role: 'assistant', content: full });
            
            const lat = tFirst ? ((tFirst - t0)/1000).toFixed(2) : "0.00";
            const nTok = svrToks || count;
            const dur = (performance.now() - tFirst)/1000;
            const tps = svrSpeed ? svrSpeed.toFixed(2) : (nTok/Math.max(dur, 0.01)).toFixed(2);
            const displayModel = serverModel || state.model;
            
            // Metrics styled for HFP
            dom.met.innerHTML = `
                <div class="flex items-center gap-1.5 px-2 py-1 bg-white rounded text-[10px] font-bold text-slate-500 border border-slate-200">
                    <i class="fa-solid fa-microchip text-slate-400"></i> ${displayModel}
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-white rounded text-[10px] font-bold text-slate-500 border border-slate-200">
                    <i class="fa-solid fa-layer-group text-slate-400"></i> ${nTok} toks
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-white rounded text-[10px] font-bold text-slate-500 border border-slate-200">
                    <i class="fa-solid fa-bolt text-blue-500"></i> ${tps} t/s
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-white rounded text-[10px] font-bold text-slate-500 border border-slate-200">
                    <i class="fa-regular fa-clock text-slate-400"></i> ${lat}s
                </div>
            `;
            dom.met.classList.remove('opacity-0');

        } catch (e) {
            if(dom.thk) dom.thk.remove();
            dom.box.classList.remove('hidden');
            dom.txt.innerHTML = `<span class="text-red-600 font-bold text-xs bg-red-50 px-2 py-1 rounded border border-red-100"><i class="fa-solid fa-circle-exclamation mr-1"></i> System Error: ${e.message}</span>`;
        }
        
        state.busy = false; 
        $('in').disabled = false; 
        $('btn').disabled = false; 
        $('btn').classList.remove('opacity-50'); 
        setTimeout(()=>$('in').focus(), 50);
    },
    clear: () => {
        state.history = []; $('chat').innerHTML = ''; $('chat').appendChild($('welcome')); $('welcome').style.display = 'flex';
    }
};

window.onload = () => { 
    app.init(true); 
    document.onclick = e => {
        if (!e.target.closest('button[onclick="ui.toggleDrop()"]') && !e.target.closest('#drop')) {
            $('drop').classList.add('hidden');
        }
    };
};
</script>
</body>
</html>
