<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>WQR.AI | Neural Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        tech: {
                            bg: '#0f172a', // Slate 950
                            panel: '#1e293b', // Slate 800
                            accent: '#06b6d4', // Cyan 500
                            dim: '#94a3b8',
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #020617; 
            color: #e2e8f0; 
            /* Tech Grid Background */
            background-image: linear-gradient(#1e293b 1px, transparent 1px), linear-gradient(90deg, #1e293b 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: center top;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: #06b6d4; }

        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .ai-text { font-family: 'Inter', sans-serif; font-size: 0.95rem; line-height: 1.6; color: #cbd5e1; white-space: pre-wrap; }
        
        /* Code block styling simulation */
        .ai-text code { font-family: 'JetBrains Mono', monospace; background: #1e293b; padding: 2px 6px; border-radius: 4px; color: #06b6d4; font-size: 0.85em; }

        /* Tech Loading Animation */
        .thinking span {
            display: inline-block;
            width: 6px; height: 6px; background-color: #06b6d4;
            margin-right: 4px; animation: blink 1s infinite;
        }
        .thinking span:nth-child(2) { animation-delay: 0.2s; }
        .thinking span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes blink { 0%, 100% { opacity: 0.2; transform: scale(0.8); } 50% { opacity: 1; transform: scale(1.2); } }

        textarea::placeholder { color: #475569; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
        
        /* Glassmorphism for panels */
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(51, 65, 85, 0.5); }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden relative text-sm md:text-base font-sans selection:bg-cyan-500/30 selection:text-cyan-200">

    <header class="absolute top-0 left-0 w-full z-30 flex items-center justify-between px-4 py-3 bg-gradient-to-b from-[#020617] to-transparent">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-slate-800 rounded-md border border-slate-700 flex items-center justify-center shadow-[0_0_15px_rgba(6,182,212,0.15)]">
                <i class="fa-solid fa-network-wired text-cyan-400 text-sm"></i>
            </div>
            <div class="flex flex-col">
                <span class="font-mono font-bold text-slate-100 leading-none tracking-tight text-sm">WQR<span class="text-cyan-400">.AI</span></span>
                <span class="text-[9px] font-mono text-slate-500 uppercase tracking-widest mt-0.5">Neural Node</span>
            </div>
        </div>

        <div class="flex items-center gap-2 bg-slate-900/80 border border-slate-700 pl-2.5 pr-3 py-1 rounded-full shadow-lg">
            <div id="dot" class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
            <span id="stat" class="text-[9px] font-mono font-bold text-slate-500 tracking-wider">OFFLINE</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col max-w-4xl mx-auto w-full relative min-h-0 pt-16">
        <div id="chat" class="flex-1 overflow-y-auto px-4 md:px-6 py-4 space-y-6 md:space-y-8 scroll-smooth pb-4 custom-scroll">
            
            <div id="welcome" class="flex flex-col items-center justify-center h-full text-slate-500 select-none transition-opacity duration-300">
                <div class="relative w-20 h-20 mb-6 group">
                    <div class="absolute inset-0 bg-cyan-500/10 rounded-full blur-xl group-hover:bg-cyan-500/20 transition-all duration-500"></div>
                    <div class="relative w-full h-full bg-slate-900 rounded-2xl flex items-center justify-center border border-slate-800 shadow-2xl">
                        <i class="fa-solid fa-fingerprint text-4xl text-cyan-500 opacity-90"></i>
                    </div>
                </div>
                <h1 class="text-2xl font-mono font-bold text-slate-200 mb-2 tracking-tight">Waqar's Intelligence</h1>
                <p class="text-[10px] font-mono text-cyan-500/70 uppercase tracking-[0.2em] mb-8 border border-cyan-900/50 px-3 py-1 rounded-full bg-cyan-950/20">System Ready</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3 max-w-md w-full">
                    <div class="bg-slate-900/50 border border-slate-800 p-3 rounded-lg text-center hover:border-cyan-500/30 transition-colors cursor-default">
                        <i class="fa-solid fa-code text-slate-400 mb-2"></i>
                        <p class="text-xs text-slate-400">Code Generation</p>
                    </div>
                    <div class="bg-slate-900/50 border border-slate-800 p-3 rounded-lg text-center hover:border-cyan-500/30 transition-colors cursor-default">
                        <i class="fa-solid fa-database text-slate-400 mb-2"></i>
                        <p class="text-xs text-slate-400">Data Analysis</p>
                    </div>
                </div>
            </div>

            <div id="msg-container" class="flex flex-col gap-6 w-full"></div>

        </div>
        
        <div class="px-2 md:px-4 pb-3 md:pb-5 pt-2 w-full z-20">
            <div class="max-w-4xl mx-auto relative flex flex-col gap-2">
                
                <div class="glass-panel rounded-2xl px-3 md:px-4 py-3 relative shadow-2xl transition-all focus-within:border-cyan-500/50 focus-within:shadow-[0_0_20px_rgba(6,182,212,0.1)]">
                    
                    <textarea id="in" rows="1" class="w-full bg-transparent border-none outline-none text-sm md:text-base text-slate-200 resize-none max-h-32 focus:ring-0 p-0 placeholder:text-slate-600" placeholder="Execute command or query..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();app.send();}"></textarea>
                    
                    <div class="flex items-center justify-between mt-3 gap-2 flex-wrap sm:flex-nowrap">
                        
                        <button onclick="app.clear()" class="flex-none flex items-center gap-2 px-3 py-1.5 rounded-lg bg-slate-800/50 hover:bg-slate-800 text-slate-400 hover:text-cyan-400 transition-all border border-slate-700/50 hover:border-cyan-500/30 text-[10px] font-mono font-bold group">
                            <i class="fa-solid fa-trash-can text-[10px]"></i> <span class="hidden sm:inline">PURGE</span>
                        </button>

                        <div class="flex items-center gap-3 relative ml-auto sm:ml-0 max-w-full">
                            
                            <div class="relative flex-shrink min-w-0">
                                <button onclick="ui.toggleDrop()" class="flex items-center gap-2 px-3 py-1.5 bg-slate-800/50 hover:bg-slate-800 border border-slate-700/50 hover:border-cyan-500/30 rounded-lg transition-all cursor-pointer w-full max-w-[140px] md:max-w-none group">
                                    <i class="fa-solid fa-microchip text-cyan-600 group-hover:text-cyan-400 text-[10px] flex-none transition-colors"></i>
                                    <span id="h-model" class="text-[10px] font-mono font-bold text-slate-400 group-hover:text-slate-200 truncate block transition-colors">INITIALIZING...</span>
                                </button>

                                <div id="drop" class="absolute bottom-full right-0 mb-2 w-64 max-w-[85vw] bg-[#0f172a] border border-slate-700 rounded-xl shadow-2xl hidden z-50 flex flex-col overflow-hidden ring-1 ring-black/50">
                                    <div class="p-2 border-b border-slate-800 flex justify-between items-center bg-slate-900">
                                        <span class="text-[10px] font-mono font-bold text-cyan-500 uppercase">Select Core</span>
                                        <span id="cnt" class="text-[9px] bg-cyan-900/30 text-cyan-400 border border-cyan-800 font-mono px-1.5 rounded">0</span>
                                    </div>
                                    <div id="list" class="max-h-56 overflow-y-auto p-1 custom-scroll"></div>
                                </div>
                            </div>

                            <button id="btn" onclick="app.send()" class="w-9 h-9 rounded-lg bg-cyan-600 text-white hover:bg-cyan-500 hover:shadow-[0_0_15px_rgba(6,182,212,0.4)] transition-all flex items-center justify-center shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex-none disabled:shadow-none active:scale-95">
                                <i class="fa-solid fa-arrow-right text-sm"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-center items-center gap-2 opacity-60">
                    <div class="h-px w-8 bg-gradient-to-r from-transparent to-slate-700"></div>
                    <div class="text-[9px] font-mono text-slate-500 uppercase tracking-widest">Waqar's AI v2.0</div>
                    <div class="h-px w-8 bg-gradient-to-l from-transparent to-slate-700"></div>
                </div>
            </div>
        </div>
    </main>

<script>
const $ = id => document.getElementById(id);
const API = ''; // Default local address
const state = { model: "Unknown", list: [], connected: false, history: [], busy: false };

const ui = {
    toggleDrop: () => $('drop').classList.toggle('hidden'),
    
    setStatus: (online, msg) => {
        $('dot').className = `w-1.5 h-1.5 rounded-full ${online ? 'bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]' : 'bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]'}`;
        $('stat').innerText = online ? "ONLINE" : "OFFLINE";
        $('stat').className = `text-[9px] font-mono font-bold tracking-wider ${online ? 'text-emerald-500' : 'text-slate-500'}`;
        if(msg) $('h-model').innerText = msg;
    },
    
    setModel: (id) => {
        state.model = id;
        $('h-model').innerText = id;
        $('drop').classList.add('hidden');
        ui.renderList();
    },
    
    renderList: () => {
        $('list').innerHTML = '';
        $('cnt').innerText = state.list.length;
        if(!state.list.length) $('list').innerHTML = '<div class="p-3 text-center text-[10px] text-slate-600 font-mono">NO CORES DETECTED</div>';
        
        state.list.forEach(m => {
            const btn = document.createElement('button');
            const active = m.id === state.model;
            btn.className = `w-full text-left px-3 py-2.5 text-[11px] font-mono flex items-center gap-3 rounded-md transition-all border border-transparent ${active ? 'bg-cyan-900/20 text-cyan-400 border-cyan-800/50' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'}`;
            btn.innerHTML = `
                <div class="w-1.5 h-1.5 rounded-full flex-none ${active ? 'bg-cyan-400 shadow-[0_0_5px_rgba(34,211,238,0.8)]' : 'bg-slate-600'}"></div>
                <div class="flex-1 break-all">${m.id}</div>
            `;
            btn.onclick = () => ui.setModel(m.id);
            $('list').appendChild(btn);
        });
    },

    addMsg: (role, text, thinking=false) => {
        const div = document.createElement('div');
        div.className = `flex w-full fade-in ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        
        if (role === 'user') {
            div.innerHTML = `
                <div class="bg-cyan-700/20 backdrop-blur-sm text-cyan-100 font-medium px-4 py-3 rounded-2xl rounded-tr-sm text-[14px] max-w-[88%] md:max-w-[80%] border border-cyan-800/50 break-words leading-relaxed shadow-lg">
                    ${text}
                </div>
            `;
        } else {
            div.innerHTML = `
                <div class="w-full max-w-full group">
                    <div class="flex items-center gap-2 mb-1 pl-1">
                        <i class="fa-solid fa-robot text-[10px] text-cyan-500"></i>
                        <span class="text-[10px] font-mono text-cyan-500/50 uppercase">WQR.AI Response</span>
                    </div>
                    
                    <div class="bg-[#151f32] border border-slate-800 rounded-xl rounded-tl-sm px-4 py-3 shadow-sm relative overflow-hidden">
                        ${thinking ? `
                            <div id="thk" class="thinking py-1">
                                <span></span><span></span><span></span>
                            </div>` : ''}
                        
                        <div class="${thinking ? 'hidden' : ''}" id="content-box">
                            <div class="ai-text text-slate-300"></div>
                        </div>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mt-2 opacity-0 transition-opacity duration-500 pl-1" id="metrics"></div>
                </div>`;
        }
        
        $('msg-container').appendChild(div);
        $('chat').scrollTop = $('chat').scrollHeight;
        
        return role === 'ai' ? { 
            box: div.querySelector('#content-box'), 
            txt: div.querySelector('.ai-text'), 
            met: div.querySelector('#metrics'),
            thk: div.querySelector('#thk') 
        } : null;
    }
};

const app = {
    init: async (refresh=false) => {
        if(refresh) $('list').innerHTML = '<div class="p-4 text-center text-[10px] font-mono text-slate-500">SCANNING...</div>';
        try {
            const res = await fetch(`${API}/models`);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            
            const rawList = data.data || data || []; 
            state.list = rawList.map(m => {
                const id = (m.id || m).split('/').pop().replace('.gguf','');
                return { id: id };
            });

            if(!state.list.find(m=>m.id===state.model)) state.model = state.list[0]?.id || "No Cores";
            
            state.connected = true;
            ui.setStatus(true);
            ui.setModel(state.model);
        } catch (e) {
            console.error(e);
            state.connected = false;
            ui.setStatus(false, "Offline");
            state.list = [];
            ui.renderList();
        }
    },
    
    send: async () => {
        const text = $('in').value.trim();
        if(!text || state.busy) return;
        
        if(!state.connected && state.list.length === 0) { 
           await app.init();
           if(!state.connected) { alert('Cannot connect to Neural Core.'); return; }
        }
        
        state.busy = true;
        $('welcome').style.display = 'none';
        $('in').value = ''; $('in').disabled = true; $('btn').disabled = true; $('btn').classList.add('opacity-50');
        
        state.history.push({ role: 'user', content: text });
        ui.addMsg('user', text);
        const dom = ui.addMsg('ai', '', true);

        let full = "", t0 = performance.now(), tFirst = 0, count = 0, svrToks = 0, svrSpeed = 0, serverModel = "";
        
        try {
            const res = await fetch(`${API}/chat/completions`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ model: state.model, messages: state.history, stream: true })
            });
            
            if(!res.ok) throw new Error("API Error");

            const reader = res.body.getReader();
            const dec = new TextDecoder();

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = dec.decode(value);
                const lines = chunk.split('\n');
                
                for(const line of lines) {
                    if(line.startsWith('data: ') && !line.includes('[DONE]')) {
                        try {
                            const json = JSON.parse(line.slice(6));
                            if(json.model && !serverModel) {
                                serverModel = json.model.split('/').pop().replace('.gguf','');
                                if (state.model !== serverModel) ui.setModel(serverModel);
                            }

                            if(json.timings?.predicted_n) svrSpeed = json.timings.predicted_n / (json.timings.predicted_ms/1000);
                            if(json.usage?.completion_tokens) svrToks = json.usage.completion_tokens;
                            const delta = json.choices[0]?.delta?.content;
                            if(delta) {
                                if(!tFirst) { tFirst = performance.now(); dom.thk.remove(); dom.box.classList.remove('hidden'); }
                                full += delta; dom.txt.textContent = full; count++;
                                $('chat').scrollTop = $('chat').scrollHeight;
                            }
                        } catch {}
                    }
                }
            }
            state.history.push({ role: 'assistant', content: full });
            
            const lat = tFirst ? ((tFirst - t0)/1000).toFixed(2) : "0.00";
            const nTok = svrToks || count;
            const tps = svrSpeed ? svrSpeed.toFixed(2) : (nTok/Math.max((performance.now() - tFirst)/1000, 0.01)).toFixed(2);
            
            // HUD Style Metrics
            dom.met.innerHTML = `
                <div class="flex items-center gap-1.5 px-2 py-1 bg-slate-900 rounded text-[9px] font-mono font-bold text-slate-500 border border-slate-800">
                    <i class="fa-solid fa-microchip text-slate-600"></i> ${serverModel || state.model}
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-slate-900 rounded text-[9px] font-mono font-bold text-slate-500 border border-slate-800">
                    <i class="fa-solid fa-terminal text-emerald-500"></i> ${nTok} TKS
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-slate-900 rounded text-[9px] font-mono font-bold text-slate-500 border border-slate-800">
                    <i class="fa-regular fa-clock text-purple-500"></i> ${lat}s
                </div>
            `;
            dom.met.classList.remove('opacity-0');

        } catch (e) {
            if(dom.thk) dom.thk.remove();
            dom.box.classList.remove('hidden');
            dom.txt.innerHTML = `<span class="text-red-400 font-mono text-xs bg-red-900/20 px-2 py-1 rounded border border-red-500/30"><i class="fa-solid fa-triangle-exclamation mr-1"></i> PROTOCOL ERROR: ${e.message}</span>`;
        }
        
        state.busy = false; 
        $('in').disabled = false; 
        $('btn').disabled = false; 
        $('btn').classList.remove('opacity-50'); 
        setTimeout(()=>$('in').focus(), 50);
    },
    
    clear: () => {
        state.history = []; 
        $('msg-container').innerHTML = '';
        $('welcome').style.display = 'flex';
    }
};

window.onload = () => { 
    app.init(true); 
    document.onclick = e => {
        if (!e.target.closest('button[onclick="ui.toggleDrop()"]') && !e.target.closest('#drop')) {
            $('drop').classList.add('hidden');
        }
    };
};
</script>
</body>
</html>

                    