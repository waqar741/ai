<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>HFP AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Merriweather:wght@300;400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #111827; }
        
        /* Custom Scrollbar - hidden on mobile for cleaner look */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        @media (max-width: 640px) { ::-webkit-scrollbar { display: none; } }
        
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* AI Text Styling */
        .ai-text { 
            font-family: 'Merriweather', serif; 
            font-size: 1rem; 
            line-height: 1.6; 
            color: #000000;
            white-space: pre-wrap; 
        }
        /* Smaller text on mobile */
        @media (max-width: 640px) { .ai-text { font-size: 0.95rem; } }

        /* Thinking Animation */
        .thinking { display: inline-flex; gap: 4px; padding: 8px 0; }
        .dot { width: 4px; height: 4px; background: #6b7280; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(1) { animation-delay: -0.32s; }
        .dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }

        /* Input Placeholder */
        textarea::placeholder { color: #6b7280; font-size: 13px; font-weight: 500; }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden bg-white relative text-sm md:text-base">

    <header class="absolute top-3 right-3 md:top-4 md:right-6 z-30">
        <div class="flex items-center gap-1.5 bg-white/90 backdrop-blur border border-gray-200 px-2.5 py-1 rounded-full shadow-sm">
            <div id="dot" class="w-2 h-2 rounded-full bg-red-500"></div>
            <span id="stat" class="text-[9px] md:text-[10px] uppercase font-extrabold text-gray-500 tracking-wider">OFFLINE</span>
        </div>
    </header>

    <main class="flex-1 flex flex-col max-w-3xl mx-auto w-full relative min-h-0">
        <div id="chat" class="flex-1 overflow-y-auto px-3 md:px-4 py-4 space-y-5 md:space-y-6 scroll-smooth pb-2">
            <div id="welcome" class="flex flex-col items-center justify-center h-full text-gray-400">
                <i class="fa-solid fa-feather text-3xl mb-2 opacity-50"></i>
                <p class="text-sm font-semibold text-gray-500">How can I help you today?</p>
            </div>
        </div>
        
        <div class="px-2 md:px-4 pb-2 md:pb-3 pt-2 w-full z-20 bg-white">
            <div class="max-w-3xl mx-auto relative flex flex-col gap-2">
                
                <div class="bg-[#f3f4f6] rounded-[24px] px-3 md:px-4 py-3 relative shadow-sm transition-all focus-within:ring-2 focus-within:ring-gray-200 border border-gray-200">
                    
                    <textarea id="in" rows="1" class="w-full bg-transparent border-none outline-none text-sm font-medium text-black resize-none max-h-32 focus:ring-0 p-0" placeholder="Ask anything..." oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();app.send();}"></textarea>
                    
                    <div class="flex items-center justify-between mt-2 gap-2 flex-wrap sm:flex-nowrap">
                        
                        <button onclick="app.clear()" class="flex-none flex items-center gap-1.5 px-2.5 py-1.5 rounded-full bg-white hover:bg-gray-200 text-gray-700 hover:text-black transition-colors border border-gray-300 shadow-sm text-[10px] font-bold">
                            <i class="fa-solid fa-plus text-[10px]"></i> <span class="hidden xs:inline">New Context</span><span class="xs:hidden">New</span>
                        </button>

                        <div class="flex items-center gap-2 relative ml-auto sm:ml-0 max-w-full">
                            
                            <div class="relative flex-shrink min-w-0">
                                <button onclick="ui.toggleDrop()" class="flex items-center gap-1.5 px-2.5 py-1.5 bg-white hover:bg-gray-50 border border-gray-300 rounded-lg transition-all cursor-pointer shadow-sm group w-full max-w-[140px] md:max-w-none">
                                    <i class="fa-solid fa-cube text-gray-500 text-[10px] flex-none"></i>
                                    <span id="h-model" class="text-[10px] font-bold text-gray-800 truncate block">Loading...</span>
                                    <i class="fa-solid fa-chevron-up text-[9px] text-gray-400 flex-none ml-auto"></i>
                                </button>

                                <div id="drop" class="absolute bottom-full right-0 mb-1 w-64 max-w-[90vw] bg-white border border-gray-200 rounded-xl shadow-xl hidden z-50 flex flex-col overflow-hidden ring-1 ring-black/5">
                                    <div class="p-2 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                        <span class="text-[10px] font-bold text-gray-500 uppercase">Select Model</span>
                                        <span id="cnt" class="text-[9px] bg-gray-200 text-gray-700 font-bold px-1.5 rounded-full">0</span>
                                    </div>
                                    <div id="list" class="max-h-48 overflow-y-auto p-1 custom-scroll"></div>
                                </div>
                            </div>

                            <button id="btn" onclick="app.send()" class="w-8 h-8 rounded-full bg-black text-white hover:bg-gray-800 transition-all flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex-none">
                                <i class="fa-solid fa-arrow-up text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center text-[9px] md:text-[10px] font-medium text-gray-400 px-2">
                    AI can make mistakes. Check important info.
                </div>
            </div>
        </div>
    </main>

<script>
const $ = id => document.getElementById(id);
const API = 'https://ai.nomineelife.com/v1'; 
const state = { model: "Unknown", list: [], connected: false, history: [], busy: false };

const ui = {
    toggleDrop: () => $('drop').classList.toggle('hidden'),
    
    setStatus: (online, msg) => {
        $('dot').className = `w-2 h-2 rounded-full ${online ? 'bg-green-500' : 'bg-red-500'}`;
        $('stat').innerText = online ? "ONLINE" : "OFFLINE";
        $('stat').className = `text-[9px] md:text-[10px] uppercase font-extrabold tracking-wider ${online ? 'text-green-700' : 'text-gray-500'}`;
        if(msg) $('h-model').innerText = msg;
    },
    
    setModel: (id) => {
        state.model = id;
        $('h-model').innerText = id;
        $('drop').classList.add('hidden');
        ui.renderList();
    },
    
    renderList: () => {
        $('list').innerHTML = '';
        $('cnt').innerText = state.list.length;
        if(!state.list.length) $('list').innerHTML = '<div class="p-3 text-center text-[10px] text-gray-500 font-medium">No models found</div>';
        
        state.list.forEach(m => {
            const btn = document.createElement('button');
            const active = m.id === state.model;
            btn.className = `w-full text-left px-2 py-2 text-[10px] flex items-center gap-2 rounded-md transition-all border border-transparent ${active ? 'bg-gray-100 text-black font-bold border-gray-200' : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900 font-medium'}`;
            btn.innerHTML = `
                <div class="w-1.5 h-1.5 rounded-full flex-none ${active ? 'bg-green-600' : 'bg-gray-300'}"></div>
                <div class="flex-1 break-all">${m.id}</div>
            `;
            btn.onclick = () => ui.setModel(m.id);
            $('list').appendChild(btn);
        });
    },

    addMsg: (role, text, thinking=false) => {
        const div = document.createElement('div');
        div.className = `flex w-full fade-in ${role === 'user' ? 'justify-end' : 'justify-start'}`;
        
        if (role === 'user') {
            div.innerHTML = `
                <div class="bg-gray-100 text-black font-medium px-4 py-2 rounded-[18px] text-[14px] max-w-[90%] md:max-w-[85%] shadow-sm border border-gray-200 break-words">
                    ${text}
                </div>
            `;
        } else {
            div.innerHTML = `
                <div class="w-full max-w-full">
                    ${thinking ? `
                        <div id="thk" class="thinking pl-1">
                            <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                        </div>` : ''}
                    
                    <div class="${thinking ? 'hidden' : ''}" id="content-box">
                        <div class="ai-text pl-1 text-[15px]"></div>
                    </div>
                    
                    <div class="flex flex-wrap gap-1.5 mt-2 opacity-0 transition-opacity duration-500 pl-1" id="metrics"></div>
                </div>`;
        }
        
        $('chat').appendChild(div);
        $('chat').scrollTop = $('chat').scrollHeight;
        
        return role === 'ai' ? { 
            box: div.querySelector('#content-box'), 
            txt: div.querySelector('.ai-text'), 
            met: div.querySelector('#metrics'),
            thk: div.querySelector('#thk') 
        } : null;
    }
};

const app = {
    init: async (refresh=false) => {
        if(refresh) $('list').innerHTML = '<div class="p-4 text-center text-xs text-gray-500">Loading...</div>';
        try {
            const res = await fetch(`${API}/models?t=${Date.now()}`);
            if(!res.ok) throw new Error("API Error");
            const data = await res.json();
            state.list = data.data || [];
            state.list = state.list.map(m => ({ ...m, id: m.id.split('/').pop().replace('.gguf','') }));

            if(!state.list.find(m=>m.id===state.model)) state.model = state.list[0]?.id || "No Models";
            state.connected = true;
            ui.setStatus(true);
            ui.setModel(state.model);
        } catch (e) {
            console.error(e);
            state.connected = false;
            ui.setStatus(false, "Offline");
            state.list = [];
            ui.renderList();
        }
    },
    
    send: async () => {
        const text = $('in').value.trim();
        if(!text || state.busy) return;
        
        if(!state.connected && state.list.length === 0) { 
           await app.init();
           if(!state.connected) { alert('Cannot connect to server.'); return; }
        }
        
        state.busy = true;
        $('welcome').style.display = 'none';
        $('in').value = ''; $('in').disabled = true; $('btn').disabled = true; $('btn').classList.add('opacity-50');
        
        state.history.push({ role: 'user', content: text });
        ui.addMsg('user', text);
        const dom = ui.addMsg('ai', '', true);

        let full = "", t0 = performance.now(), tFirst = 0, count = 0, svrToks = 0, svrSpeed = 0, serverModel = "";
        
        try {
            const res = await fetch(`${API}/chat/completions`, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ model: state.model, messages: state.history, stream: true })
            });
            
            if(!res.ok) throw new Error("API Error: " + res.status);

            const reader = res.body.getReader();
            const dec = new TextDecoder();

            while(true) {
                const {done, value} = await reader.read();
                if(done) break;
                const chunk = dec.decode(value);
                const lines = chunk.split('\n');
                
                for(const line of lines) {
                    if(line.startsWith('data: ') && !line.includes('[DONE]')) {
                        try {
                            const json = JSON.parse(line.slice(6));
                            if(json.model && !serverModel) {
                                serverModel = json.model.split('/').pop().replace('.gguf','');
                            }
                            if(json.timings?.predicted_n) svrSpeed = json.timings.predicted_n / (json.timings.predicted_ms/1000);
                            if(json.usage?.completion_tokens) svrToks = json.usage.completion_tokens;
                            const delta = json.choices[0]?.delta?.content;
                            if(delta) {
                                if(!tFirst) { tFirst = performance.now(); dom.thk.remove(); dom.box.classList.remove('hidden'); }
                                full += delta; dom.txt.textContent = full; count++;
                                $('chat').scrollTop = $('chat').scrollHeight;
                            }
                        } catch {}
                    }
                }
            }
            state.history.push({ role: 'assistant', content: full });
            
            const lat = tFirst ? ((tFirst - t0)/1000).toFixed(2) : "0.00";
            const nTok = svrToks || count;
            const dur = (performance.now() - tFirst)/1000;
            const tps = svrSpeed ? svrSpeed.toFixed(2) : (nTok/Math.max(dur, 0.01)).toFixed(2);
            const displayModel = serverModel || state.model;
            
            dom.met.innerHTML = `
                <div class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded text-[10px] font-bold text-gray-700 border border-gray-200">
                    <i class="fa-solid fa-microchip text-gray-500"></i> ${displayModel}
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded text-[10px] font-bold text-gray-700 border border-gray-200">
                    <i class="fa-solid fa-layer-group text-gray-500"></i> ${nTok} toks
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded text-[10px] font-bold text-gray-700 border border-gray-200">
                    <i class="fa-solid fa-bolt text-blue-500"></i> ${tps} t/s
                </div>
                <div class="flex items-center gap-1.5 px-2 py-1 bg-gray-100 rounded text-[10px] font-bold text-gray-700 border border-gray-200">
                    <i class="fa-regular fa-clock text-gray-500"></i> ${lat}s
                </div>
            `;
            dom.met.classList.remove('opacity-0');

        } catch (e) {
            if(dom.thk) dom.thk.remove();
            dom.box.classList.remove('hidden');
            dom.txt.innerHTML = `<span class="text-red-600 font-bold text-xs">Error: ${e.message}</span>`;
        }
        
        state.busy = false; 
        $('in').disabled = false; 
        $('btn').disabled = false; 
        $('btn').classList.remove('opacity-50'); 
        setTimeout(()=>$('in').focus(), 50);
    },
    clear: () => {
        state.history = []; $('chat').innerHTML = ''; $('chat').appendChild($('welcome')); $('welcome').style.display = 'flex';
    }
};

window.onload = () => { 
    app.init(true); 
    document.onclick = e => {
        if (!e.target.closest('button[onclick="ui.toggleDrop()"]') && !e.target.closest('#drop')) {
            $('drop').classList.add('hidden');
        }
    };
};
</script>
</body>
</html>
